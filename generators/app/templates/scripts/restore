#!/bin/bash

set -eu

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

. /usr/share/yunohost/helpers

#=================================================
# MANAGE SCRIPT FAILURE
#=================================================

ynh_abort_if_errors

#=================================================
# LOAD SETTINGS
#=================================================

app=$YNH_APP_INSTANCE_NAME
domain=$(ynh_app_setting_get "$app" domain)
<% if (defaultPathOption != "") { %>path=$(ynh_app_setting_get "$app" path)
<% } %>

#=================================================
# CHECK IF THE APP CAN BE RESTORED
#=================================================

test ! -d /home/yunohost.docker/$app \
        || ynh_die "There is already a directory: /home/yunohost.docker/$app "

#=================================================
# IMPORT GENERIC HELPERS AFTER YNH_DIE FOR LINTER
#=================================================

[ ! -e _common ] && cp ../settings/scripts/_common ./.
[ ! -e _dockertest ] && cp ../settings/scripts/_dockertest ./.
[ ! -e docker/ ] && cp -rf ../settings/scripts/docker/ ./.
. _common

#=================================================
# CHECK IF THE APP CAN BE INSTALLED WITH THESE ARGS
#=================================================

# check or install docker
dockerapp_ynh_checkinstalldocker

#=================================================
# MODIFY A CONFIG FILE
#=================================================

dockerapp_ynh_loadvariables
dockerapp_ynh_findreplaceallvaribles

#=================================================
# RESTORE THE APP MAIN DIR
#=================================================

sudo cp -a ./data "$data_path"

#=================================================
# START AND CREATE SERVICE
#=================================================

# docker run
dockerapp_ynh_run

#=================================================
# RESTORE THE NGINX CONFIGURATION
#=================================================

cp -a ./conf/nginx.conf "/etc/nginx/conf.d/$domain.d/$app.conf"

#=================================================
# RELOAD NGINX
#=================================================

# Reload Nginx and regenerate SSOwat conf
dockerapp_ynh_reloadservices
