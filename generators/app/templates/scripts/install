#!/bin/bash

set -eu

# Retrieve arguments
app=$YNH_APP_INSTANCE_NAME
domain=$YNH_APP_ARG_DOMAIN
<% if (defaultPath != "") { %>path=$YNH_APP_ARG_PATH
<% } %>is_public=$YNH_APP_ARG_IS_PUBLIC

# Source YunoHost helpers
. /usr/share/yunohost/helpers
. _common
ynh_abort_if_errors

# store settings
ynh_app_setting_set $app is_public $is_public

# check or install docker
dockerapp_ynh_checkinstalldocker

# Check domain/path availability
dockerapp_ynh_loadvariables
ynh_webpath_available $domain $path
ynh_webpath_register $app $domain $path

# Copy files to the right place
sudo rm -rf $data_path
sudo mkdir -p $data_path

# docker run
dockerapp_ynh_run

# Modify Nginx configuration file and copy it to Nginx conf directory
dockerapp_ynh_preparenginx

# Make app public if necessary or protect it
if [ $is_public -eq 1 ]
then
        ynh_app_setting_set $app skipped_uris "/"
fi

# Reload Nginx and regenerate SSOwat conf
dockerapp_ynh_reloadservices
